-- ============================================================================
-- Chat Data Only Cleanup Script
-- ============================================================================
-- μƒμ„±μΌ: 2025-10-17
-- λ©μ : μ±„ν…/μ„Έμ… λ°μ΄ν„°λ§ μ‚­μ  (λ¶€λ™μ‚° λ°μ΄ν„° λ³΄μ΅΄)
-- μ£Όμ: μ±„ν… νμ¤ν† λ¦¬μ™€ μ²΄ν¬ν¬μΈνΈ λ°μ΄ν„°κ°€ μ‚­μ λ©λ‹λ‹¤!
-- ============================================================================

BEGIN;

\echo '=========================================='
\echo 'π—‘οΈ  μ±„ν… λ°μ΄ν„° μ‚­μ  μ‹μ‘...'
\echo '=========================================='

-- ============================================================================
-- STEP 1: ν„μ¬ λ°μ΄ν„° λ°±μ—… (λ΅¤λ°±μ©)
-- ============================================================================

\echo ''
\echo 'π“¦ λ°±μ—… ν…μ΄λΈ” μƒμ„± μ¤‘...'

-- μ±„ν… λ°μ΄ν„° λ°±μ—…
CREATE TABLE IF NOT EXISTS chat_sessions_backup AS
SELECT * FROM chat_sessions;

CREATE TABLE IF NOT EXISTS chat_messages_backup AS
SELECT * FROM chat_messages;

\echo 'β… λ°±μ—… μ™„λ£'

-- ============================================================================
-- STEP 2: μ²΄ν¬ν¬μΈνΈ λ°μ΄ν„° μ‚­μ 
-- ============================================================================

\echo ''
\echo 'π’Ύ μ²΄ν¬ν¬μΈνΈ λ°μ΄ν„° μ‚­μ  μ¤‘...'

DELETE FROM checkpoint_writes;
DELETE FROM checkpoint_blobs;
DELETE FROM checkpoints;

\echo 'β… μ²΄ν¬ν¬μΈνΈ μ‚­μ  μ™„λ£'

-- ============================================================================
-- STEP 3: μ±„ν… λ°μ΄ν„° μ‚­μ 
-- ============================================================================

\echo ''
\echo 'π’¬ μ±„ν… λ°μ΄ν„° μ‚­μ  μ¤‘...'

-- chat_messages λ¨Όμ € μ‚­μ  (FK λ•λ¬Έ)
DELETE FROM chat_messages;

-- chat_sessions μ‚­μ 
DELETE FROM chat_sessions;

\echo 'β… μ±„ν… λ°μ΄ν„° μ‚­μ  μ™„λ£'

-- ============================================================================
-- STEP 4: μ‹ν€€μ¤ λ¦¬μ…‹
-- ============================================================================

\echo ''
\echo 'π”„ μ‹ν€€μ¤ λ¦¬μ…‹ μ¤‘...'

-- chat_messages ID μ‹ν€€μ¤ λ¦¬μ…‹
ALTER SEQUENCE chat_messages_id_seq RESTART WITH 1;

\echo 'β… μ‹ν€€μ¤ λ¦¬μ…‹ μ™„λ£'

-- ============================================================================
-- STEP 5: κ²€μ¦
-- ============================================================================

\echo ''
\echo '=========================================='
\echo 'β… μ‚­μ  μ™„λ£ - κ²€μ¦ κ²°κ³Ό:'
\echo '=========================================='

-- μ‚­μ λ ν…μ΄λΈ” ν™•μΈ
\echo 'π’¬ μ±„ν… λ°μ΄ν„°:'
SELECT 'chat_sessions' as table_name, COUNT(*) as count FROM chat_sessions
UNION ALL SELECT 'chat_messages', COUNT(*) FROM chat_messages
UNION ALL SELECT 'checkpoints', COUNT(*) FROM checkpoints;

-- λ³΄μ΅΄λ ν…μ΄λΈ” ν™•μΈ
\echo ''
\echo 'πΆ λ¶€λ™μ‚° λ°μ΄ν„° (λ³΄μ΅΄λ¨):'
SELECT 'real_estates' as table_name, COUNT(*) as count FROM real_estates
UNION ALL SELECT 'transactions', COUNT(*) FROM transactions
UNION ALL SELECT 'regions', COUNT(*) FROM regions;

\echo ''
\echo '=========================================='
\echo 'π“ λ‹¤μ λ‹¨κ³„:'
\echo '=========================================='
\echo '1. κ²€μ¦ κ²°κ³Ό ν™•μΈ'
\echo '2. λ¬Έμ  μ—†μΌλ©΄: COMMIT; μ…λ ¥'
\echo '3. λ¬Έμ  μμΌλ©΄: ROLLBACK; μ…λ ¥'
\echo ''
\echo 'λ΅¤λ°± λ°©λ²•:'
\echo '  ROLLBACK;'
\echo '  INSERT INTO chat_sessions SELECT * FROM chat_sessions_backup;'
\echo '  INSERT INTO chat_messages SELECT * FROM chat_messages_backup;'
\echo '=========================================='

-- ============================================================================
-- μ‚¬μ©μ ν™•μΈ λ€κΈ° (μλ™ COMMIT μ• ν•¨)
-- ============================================================================

\echo ''
\echo 'βΈοΈ  νΈλμ­μ… λ€κΈ° μ¤‘... COMMIT λλ” ROLLBACKμ„ μ…λ ¥ν•μ„Έμ”.'

-- COMMIT λλ” ROLLBACKμ€ μ‚¬μ©μκ°€ μ§μ ‘ μ‹¤ν–‰

// ============================================================================
// HolmesNyangz Simplified Database Schema
// ============================================================================
// Purpose: Minimal schema for chat message persistence + state management
// Total Tables: 6 (Core: 2, Checkpoint: 4)
//
// Usage:
// 1. Copy all content below
// 2. Go to https://dbdiagram.io/d
// 3. Paste into the editor
// ============================================================================

// ============================================================================
// Core Tables (2 tables only!)
// ============================================================================

Table chat_sessions {
  session_id varchar(100) [pk, note: 'Chat session ID (also used as LangGraph thread_id)']
  user_id integer [not null, default: 1, note: 'User ID (temporary hardcoded)']
  title varchar(200) [not null, default: '새 대화', note: 'Session title (auto-generated from first message)']
  created_at timestamp [not null, default: `now()`]
  updated_at timestamp [not null, default: `now()`]

  indexes {
    user_id
    (user_id, updated_at)
  }

  Note: '''
  GPT-style chat sessions
  - Each session = independent conversation thread
  - session_id is used as LangGraph thread_id (unified!)
  '''
}

Table chat_messages {
  id serial [pk]
  session_id varchar(100) [not null, ref: > chat_sessions.session_id]
  role varchar(20) [not null, note: 'user | assistant | system']
  content text [not null, note: 'Message content']
  created_at timestamp [not null, default: `now()`]

  indexes {
    session_id
    (session_id, created_at)
  }

  Note: 'Chat message history for UI display'
}

// ============================================================================
// LangGraph Checkpoint Tables (4 tables - LangGraph standard)
// ============================================================================

Table checkpoints {
  thread_id text [not null, note: 'LangGraph thread ID (= chat_sessions.session_id)']
  checkpoint_ns text [not null, default: '']
  checkpoint_id text [not null]
  parent_checkpoint_id text
  type text
  checkpoint jsonb [not null]
  metadata jsonb [not null, default: `{}`]

  indexes {
    thread_id
    (thread_id, checkpoint_ns, checkpoint_id) [pk]
  }

  Note: 'LangGraph state snapshots for pause/resume'
}

Table checkpoint_blobs {
  thread_id text [not null]
  checkpoint_ns text [not null, default: '']
  channel text [not null]
  version text [not null]
  type text [not null]
  blob bytea

  indexes {
    (thread_id, checkpoint_ns, channel, version) [pk]
  }

  Note: 'LangGraph binary data storage'
}

Table checkpoint_writes {
  thread_id text [not null]
  checkpoint_ns text [not null, default: '']
  checkpoint_id text [not null]
  task_id text [not null]
  idx integer [not null]
  channel text [not null]
  type text
  blob bytea [not null]

  indexes {
    thread_id
    (thread_id, checkpoint_ns, checkpoint_id, task_id, idx) [pk]
  }

  Note: 'LangGraph incremental state updates'
}

Table checkpoint_migrations {
  v integer [pk]

  Note: 'LangGraph schema version tracking'
}

// ============================================================================
// Key Concept: Unified ID System
// ============================================================================

// session_id (chat_sessions) = thread_id (checkpoints)
//
// How it works:
// 1. User starts new chat → session_id = "chat_abc123"
// 2. Messages stored → chat_messages.session_id = "chat_abc123"
// 3. LangGraph state saved → thread_id = "chat_abc123"
// 4. Resume chat → load by same session_id → state auto-restored!
//
// No more confusion! One ID for everything.

// ============================================================================
// Foreign Key Relationships
// ============================================================================

// chat_messages.session_id → chat_sessions.session_id (CASCADE delete)
// checkpoints.thread_id → chat_sessions.session_id (implicit, TEXT type)

// ============================================================================
// Tables Removed (vs. original schema)
// ============================================================================

// ❌ sessions (HTTP/WebSocket) - WebSocket managed in memory
// ❌ conversation_memories - Duplicate of chat_messages
// ❌ entity_memories - Not needed for core functionality

// Total reduction: 9 tables → 6 tables (33% simpler!)
